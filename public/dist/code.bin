POG_LIMB_V6.5
ID:code
SOURCE_MAP:INTERNAL
---
import { NeuralLimb, LimbConfig } from './NeuralLimb';
import { CLIBridge } from '../../cli/CLIBridge';
import { AgentCapability } from '../AgentConstitution';
import { modelRouter } from '../ModelRouter';
import { BaseIntent } from '../AITypes';

export class CodeLimb extends NeuralLimb {
    private bridge: CLIBridge;

    constructor(config: LimbConfig) {
        super(config);
        this.bridge = CLIBridge.getInstance();
    }

    async analyze_complexity(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        return await this.callAI({
            type: 'text',
            prompt: `Analyze the complexity of this code and return a JSON with {score: number, tier: "LOW"|"MEDIUM"|"HIGH", analysis: string}: ${params.code || params.payload?.code}`,
            ...params,
            ...intent
        });
    }

    async read(params: any) {
        this.enforceCapability(AgentCapability.READ_FILES);
        return await this.bridge.readFile(params.path);
    }

    async write(params: any) {
        this.enforceCapability(AgentCapability.WRITE_FILES);
        return await this.bridge.writeFile(params.path, params.content);
    }

    async complete(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        return await this.callAI({
            type: 'code',
            ...params,
            ...intent
        });
    }

    async refactor(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.MODIFY_CODE);
        return await this.callAI({
            type: 'code',
            prompt: `Refactor this code: ${params.code}`,
            systemPrompt: 'Refactor for quality and performance.',
            ...params,
            ...intent
        });
    }

    async explain(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        return await this.callAI({
            type: 'text',
            prompt: `Explain this code: ${params.code}`,
            ...params,
            ...intent
        });
    }

    async test(params: any) {
        this.enforceCapability(AgentCapability.EXECUTE_COMMAND);
        return await this.bridge.runCommand(`npm run test ${params.path || ''}`);
    }

    async generate_code(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        return await this.callAI({
            type: 'code',
            prompt: `Generate code for: ${params.prompt}`,
            context: params.context,
            ...params,
            ...intent
        });
    }

    async cascade(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.MODIFY_CODE);
        return await this.callAI({
            type: 'code',
            prompt: `Cascade edit for: ${params.prompt}`,
            modelId: 'claude-3-5-sonnet',
            ...intent
        });
    }

    async audit(params: any, intent: BaseIntent) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        return await this.callAI({
            type: 'text',
            prompt: `Security audit for: ${params.code}`,
            ...intent
        });
    }

    private async callAI(request: any) {
        const response: any = await modelRouter.route(request);
        return {
            status: 'success',
            ...(typeof response === 'object' ? response : { content: response }),
            provider: response.provider || 'ai-router',
            model: response.model || 'neural-matrix',
            timestamp: Date.now()
        };
    }
}
