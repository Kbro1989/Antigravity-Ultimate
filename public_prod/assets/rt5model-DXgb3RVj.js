import{p as we,S as D,g as J,H as ge,h as Me}from"./enginecache-CxS5uUsY.js";import{ai as ue,x as Y,ad as de,p as K,bc as be,V as se,af as Xe,bd as Ye,be as Se,bf as ze,h as ye,bg as Ae}from"./three.module-aN59MUBe.js";import"./main-Cde5WehW.js";import"../src/services/rsmv/clientscript/index.ts";import"../src/services/rsmv/clientscript/interpreter.ts";let Ie=0,l=[0,0,0,0,0,0,0,0,0],o=[0,0,0,0,0,0,0,0,0];function Ze(C,le,t,q,G,N,O){let x=[0,0,0,0,0,0,0,0,0],Q=Math.cos(q*.024543693),$=Math.sin(q*.024543693);l[0]=Q,l[1]=0,l[2]=$,l[3]=0,l[4]=1,l[5]=0,l[6]=-$,l[7]=0,l[8]=Q;let w=1,g=0,M=le/32767,L=-Math.sqrt(1-Math.min(1,M*M)),Z=1-M,j=Math.sqrt(C*C+t*t);return j==0&&M==0?x=l:(j!=0&&(w=-t/j,g=C/j),o[0]=M+w*w*Z,o[1]=g*L,o[2]=g*w*Z,o[3]=-g*L,o[4]=M,o[5]=w*L,o[6]=w*g*Z,o[7]=-w*L,o[8]=M+g*g*Z,x[0]=l[0]*o[0]+l[1]*o[3]+l[2]*o[6],x[1]=l[0]*o[1]+l[1]*o[4]+l[2]*o[7],x[2]=l[0]*o[2]+l[1]*o[5]+l[2]*o[8],x[3]=l[3]*o[0]+l[4]*o[3]+l[5]*o[6],x[4]=l[3]*o[1]+l[4]*o[4]+l[5]*o[7],x[5]=l[3]*o[2]+l[4]*o[5]+l[5]*o[8],x[6]=l[6]*o[0]+l[7]*o[3]+l[8]*o[6],x[7]=l[6]*o[1]+l[7]*o[4]+l[8]*o[7],x[8]=l[6]*o[2]+l[7]*o[5]+l[8]*o[8]),x[0]*=G,x[1]*=G,x[2]*=G,x[3]*=N,x[4]*=N,x[5]*=N,x[6]*=O,x[7]*=O,x[8]*=O,x}function Ge(C,le){let t=we.oldmodels.read(C,le),q=0,G=0,N=0,O=0,x=[],Q=new ue({wireframe:!0}),$=new ue({color:16711680}),w=new Int16Array(t.vertcount),g=new Int16Array(t.vertcount),M=new Int16Array(t.vertcount),L=0,Z=0,j=0,pe=new D(t.posx),me=new D(t.posy),ce=new D(t.posz);for(let e=0;e<t.vertcount;e++){let a=t.vertflags[e];a&1&&(L+=pe.readShortSmartBias()),a&2&&(Z+=-me.readShortSmartBias()),a&4&&(j+=ce.readShortSmartBias()),w[e]=L,g[e]=Z,M[e]=j,Z>q&&(q=Z),Z<G&&(G=Z)}if(!pe.eof())throw new Error("stream not used to completion");if(!me.eof())throw new Error("stream not used to completion");if(!ce.eof())throw new Error("stream not used to completion");let ee=[];for(let e=0;e<t.texmapcount;e++){let a=t.texflags[e];ee.push({texspace:new de,vertexsum:new Y,vertexcount:0,vertexmin:new Y(1e7,1e7,1e7),vertexmax:new Y(-1e7,-1e7,-1e7),args:a})}let te=new Map,oe=new Map,_=t.material,B=t.colors,H=[],ae;if(t.modelversion>=16){ae=32767;let e=new D(t.uvs);for(;!e.eof();)H.push(e.readUShortSmart());if(!e.eof())throw new Error("stream not used to completion")}else ae=255,H=Array.from(t.uvs);if(t.mode_2){_=new Uint16Array(t.facecount),B=B.slice();for(let e=0;e<t.facecount;e++){let a=t.mode_2[e];a&2&&(_[e]=J(J(B[e])+1),B[e]=J(127),H.push((a>>2)+1))}}if(_)for(let e of _)te.set(e,(te.get(e)??0)+1);else te.set(0,t.facecount);for(let[e,a]of te){let n=a*3,m=B?t.alpha?4:3:0,b={pos:new K(new Float32Array(n*3),3),normals:new K(new Float32Array(n*3),3),color:new K(new Uint8Array(n*m),m,!0),texuvs:new K(new Float32Array(n*2),2),index:new Uint16Array(a*3),currentface:0,matid:J(e)-1};oe.set(e,b)}let F=new Uint16Array(t.facecount*3),S=0,z=0,y=0,T=0,V=new D(t.indexbuffer);for(let e=0;e<t.facecount;e++){let n=t.tritype[e]&7;if(n==1)S=T+V.readShortSmartBias(),z=S+V.readShortSmartBias(),y=z+V.readShortSmartBias(),T=y;else if(n==2)z=y,y=T+V.readShortSmartBias(),T=y;else if(n==3)S=y,y=T+V.readShortSmartBias(),T=y;else if(n==4){let m=S;S=z,z=m,y=T+V.readShortSmartBias(),T=y}else throw new Error("unkown face type");F[e*3+0]=S,F[e*3+1]=z,F[e*3+2]=y}if(!V.eof())throw new Error("stream not used to completion");if(_){let e=new Y,a=new Y,n=new Y,m=0;for(let b=0;b<t.facecount;b++){if(_[b]==0)continue;let I=m<H.length?H[m++]:0;if(I!=0&&I!=ae){let r=ee[I-1];S=F[b*3+0],z=F[b*3+1],y=F[b*3+2],e.set(w[S],g[S],M[S]),a.set(w[z],g[z],M[z]),n.set(w[y],g[y],M[y]),r.vertexsum.add(e).add(a).add(n),r.vertexmin.min(e).min(a).min(n),r.vertexmax.max(e).max(a).max(n),r.vertexcount+=3}}}let re=!1;if(t.texflags){let e=new de,a=new Y,n=new Y,m=new Y,b=new Y,s=t.texmap_verts_1??t.texmap_verts_2;for(let I=0;I<t.texflags.length;I++){let r=ee[I];if(r.args.type==0){let[u,d,c]=s[r.args.vertindex];a.set(w[u],g[u],M[u]),n.set(w[d],g[d],M[d]),m.set(w[c],g[c],M[c]),n.sub(a),m.sub(a),b.copy(n).cross(m),r.texspace.set(n.x,m.x,b.x,a.x,n.y,m.y,b.y,a.y,n.z,m.z,b.z,a.z,0,0,0,1),r.texspace.invert()}else if(r.args.type>=1){let u=t.texmap_projections[r.args.projection],d=1,c=1,i=1;if(r.args.type==1){let A=u.scale[0];A>0?(d=1,i=A/1024):A<0&&(d=-A/1024,i=1),d*=512,i*=512,c=64/(u.scale[1]&65535)}else r.args.type==2?(d=64/(u.scale[0]&65535),c=64/(u.scale[1]&65535),i=64/(u.scale[2]&65535)):(d=u.scale[0]/1024,c=u.scale[1]/1024,i=u.scale[2]/1024);isFinite(d)||(d=1,re=!0),isFinite(c)||(c=1,re=!0),isFinite(i)||(i=1,re=!0);let p=Ze(u.normal[0],u.normal[1],u.normal[2],u.rotation,d,c,i);r.texspace.set(p[0],-p[1],p[2],0,p[3],-p[4],p[5],0,p[6],-p[7],p[8],0,0,0,0,1),a.copy(r.vertexmax).add(r.vertexmin).divideScalar(-2),e.makeTranslation(a.x,a.y,a.z),r.texspace.multiply(e)}if(globalThis.testmat>=0&&globalThis.testmat==I){let u=new be([new se(.05,0),new se(.05,1),new se(.15,1),new se(0,1.15)]),d;r.args.type==0?d=new Xe(1,1):r.args.type==1?d=new Ye(.5,.5,1,10):r.args.type==2?d=new Se(1,1,1):r.args.type==3&&(d=new ze(1));let c=new ye(d,Q),i=new ye(u,$);c.matrixAutoUpdate=!1,c.matrix.copy(r.texspace).invert(),i.matrixAutoUpdate=!1,i.matrix.copy(r.texspace).invert(),x.push(c,i)}}}re&&Ie++<20&&console.warn("nonfinite texture scale");let k=null;if(t.texuvs){k=new Uint16Array(t.vertcount);let e=0;for(let a=0;a<t.texuvs.vertex.length;a++)k[a]=e,e+=t.texuvs.vertex[a]}let xe=0,f=new Y,h=new Y,v=new Y,P=new Y,W=new Y,X=new Y,ne=new Y,U=new Ae,ie=new Uint16Array(t.facecount);for(let e=0;e<t.facecount;e++)ie[e]=e;t.facepriority&&ie.sort((e,a)=>(t.facepriority[e]??0)-(t.facepriority[a]??0));for(let e=0;e<t.facecount;e++){let a=ie[e];if(S=F[a*3+0],z=F[a*3+1],y=F[a*3+2],f.set(w[S],g[S],M[S]),h.set(w[z],g[z],M[z]),v.set(w[y],g[y],M[y]),W.copy(h).sub(f),P.copy(v).sub(f).cross(W).normalize(),_&&_[a]==0&&(!B||B[a]==0)||B&&B[a]===0&&!_)continue;let n=_?_[a]:0,m=oe.get(n),b=m.currentface++,s=b*3,I=m.pos,r=m.texuvs,u=m.normals,d=m.index;if(Math.abs(1-P.length())<.01,I.setXYZ(s+0,f.x,f.y,f.z),I.setXYZ(s+1,h.x,h.y,h.z),I.setXYZ(s+2,v.x,v.y,v.z),u.setXYZ(s+0,P.x,P.y,P.z),u.setXYZ(s+1,P.x,P.y,P.z),u.setXYZ(s+2,P.x,P.y,P.z),B){let c=m.color,i=B[a],[p,A,E]=ge(Me(J(i)));if(!t.alpha)c.setXYZ(s+0,p,A,E),c.setXYZ(s+1,p,A,E),c.setXYZ(s+2,p,A,E);else{let R=(255-t.alpha[a])/255;c.setXYZW(s+0,p,A,E,R),c.setXYZW(s+1,p,A,E,R),c.setXYZW(s+2,p,A,E,R)}}if(n){let c=xe<H.length?H[xe++]:0;if(c!=0)if(c==ae)r.setXY(s+0,t.texuvs.udata[k[S]]/4096,t.texuvs.vdata[k[S]]/4096),r.setXY(s+1,t.texuvs.udata[k[z]]/4096,t.texuvs.vdata[k[z]]/4096),r.setXY(s+2,t.texuvs.udata[k[y]]/4096,t.texuvs.vdata[k[y]]/4096);else{let i=ee[c-1];if(f.applyMatrix4(i.texspace),h.applyMatrix4(i.texspace),v.applyMatrix4(i.texspace),i.args.type==0)r.setXY(s+0,f.x,f.y),r.setXY(s+1,h.x,h.y),r.setXY(s+2,v.x,v.y);else if(i.args.type==1){let p=Math.atan2(f.z,f.x)/Math.PI/2*3,A=Math.atan2(h.z,h.x)/Math.PI/2*3,E=Math.atan2(v.z,v.x)/Math.PI/2*3;r.setXY(s+0,p-.5,f.y-.5),r.setXY(s+1,A-.5,h.y-.5),r.setXY(s+2,E-.5,v.y-.5)}else if(i.args.type==2){W.copy(h).sub(f),X.copy(v).sub(f).cross(W),U.setFromMatrix4(i.texspace),X.applyMatrix3(U);let p=Math.max(X.x,-X.x,X.y,-X.y,X.z,-X.z);if(X.x==p)U.set(0,0,1,0,-1,0,0,0,0);else if(X.x==-p)U.set(0,0,-1,0,-1,0,0,0,0);else if(X.z==p)U.set(1,0,0,0,-1,0,0,0,0);else if(X.z==-p)U.set(-1,0,0,0,-1,0,0,0,0);else if(X.y==p)U.set(1,0,0,0,0,1,0,0,0);else if(X.y==-p)U.set(1,0,0,0,0,1,0,0,0);else throw new Error("unexpected");W.copy(f).applyMatrix3(U).subScalar(.5),X.copy(h).applyMatrix3(U).subScalar(.5),ne.copy(v).applyMatrix3(U).subScalar(.5),r.setXY(s+0,W.x,W.y),r.setXY(s+1,X.x,X.y),r.setXY(s+2,ne.x,ne.y)}else if(i.args.type==3){let p=Math.atan2(f.z,f.x)/Math.PI/2,A=Math.atan2(h.z,h.x)/Math.PI/2,E=Math.atan2(v.z,v.x)/Math.PI/2,R=Math.atan2(f.y,Math.sqrt(f.x*f.x+f.z*f.z))/Math.PI/2,he=Math.atan2(h.y,Math.sqrt(h.x*h.x+h.z*h.z))/Math.PI/2,ve=Math.atan2(v.y,Math.sqrt(v.x*v.x+v.z*v.z))/Math.PI/2;r.setXY(s+0,p,R),r.setXY(s+1,A,he),r.setXY(s+2,E,ve)}}if(globalThis.testmat>=0&&globalThis.testmat!=c-1){r.setXY(s+0,0,0),r.setXY(s+1,0,0),r.setXY(s+2,0,0);let i=m.color;i.setXYZ(s+0,0,0,0),i.setXYZ(s+1,0,0,0),i.setXYZ(s+2,0,0,0)}}d[b*3+0]=s+0,d[b*3+1]=s+2,d[b*3+2]=s+1}let fe=[...oe.values()].map(e=>{let a=new K(e.index,1);return{indices:a,vertexstart:0,vertexend:e.pos.count,indexLODs:[a],materialId:e.matid,hasVertexAlpha:!!t.alpha,needsNormalBlending:!0,attributes:{pos:e.pos,color:e.color,texuvs:e.texuvs,normals:e.normals}}});if(t.modelversion<=7){q*=4,G*=4;for(let a of fe){let n=a.attributes.pos.array;for(let m=0;m<n.length;m++)n[m]*=4}}return{maxy:q,miny:G,meshes:fe,bonecount:N,skincount:O,debugmeshes:x}}export{Ge as parseRT5Model};
