class c{db;constructor(t){this.db=t?.DB}async initialize(){if(!this.db){console.warn("[RealityAnchor] No D1 binding found during initialization.");return}console.log("[RealityAnchor] Ensuring D1 table exists...");try{await this.db.prepare(`
                CREATE TABLE IF NOT EXISTS reality_anchors (
                    id TEXT PRIMARY KEY,
                    projectId TEXT NOT NULL,
                    description TEXT,
                    timestamp INTEGER NOT NULL,
                    agentState TEXT,
                    workspaceState TEXT,
                    checksum TEXT,
                    provenanceType TEXT,
                    reference TEXT
                )
            `).run()}catch(t){console.error("[RealityAnchor] Table Initialization Failed",t)}}async dropAnchor(t,e,r={}){if(!this.db)return console.log("[RealityAnchor] Proxying dropAnchor to agent..."),(await fetch("/api/session/default/anchor/drop",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:t,description:e,...r})})).json();console.log(`[RealityAnchor] Dropping anchor [${r.provenanceType||"CORE"}] for project: ${t}`);const o={tokensUsed:0,activeLimbs:23,...r.agentState},a={id:`anchor_${Date.now()}_${Math.random().toString(36).slice(2,5)}`,projectId:t,description:e,timestamp:Date.now(),agentState:o,workspaceState:r.workspaceState||{},checksum:r.checksum||`sha256:prov_${Date.now()}`,provenanceType:r.provenanceType||"INTENT",reference:r.reference};if(this.db)try{await this.db.prepare("INSERT INTO reality_anchors (id, projectId, description, timestamp, agentState, workspaceState, checksum, provenanceType, reference) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)").bind(a.id,a.projectId,a.description,a.timestamp,JSON.stringify(a.agentState),JSON.stringify(a.workspaceState),a.checksum,a.provenanceType,a.reference).run(),console.log(`[RealityAnchor] Anchor ${a.id} persisted to D1`)}catch(n){console.error("[RealityAnchor] D1 Persistence Failed",n)}return a}async listAnchors(t){if(!this.db)return console.log("[RealityAnchor] Proxying listAnchors to agent..."),(await fetch(`/api/session/default/anchor/list?projectId=${t}`)).json();try{const{results:e}=await this.db.prepare("SELECT * FROM reality_anchors WHERE projectId = ? ORDER BY timestamp DESC").bind(t).all();return(e||[]).map(r=>({...r,agentState:JSON.parse(r.agentState),workspaceState:JSON.parse(r.workspaceState)}))}catch(e){return console.error("[RealityAnchor] List Anchors Failed",e),[]}}async getAnchor(t){if(this.db)try{const e=await this.db.prepare("SELECT * FROM reality_anchors WHERE id = ?").bind(t).first();return e?{...e,agentState:JSON.parse(e.agentState),workspaceState:JSON.parse(e.workspaceState)}:void 0}catch{return}}async getAnchorsForRef(t){if(!this.db)return[];try{const{results:e}=await this.db.prepare("SELECT * FROM reality_anchors WHERE reference = ?").bind(t).all();return(e||[]).map(r=>({...r,agentState:JSON.parse(r.agentState),workspaceState:JSON.parse(r.workspaceState)}))}catch{return[]}}async compactAnchors(t,e){console.log(`[RealityAnchor] Compacting anchors into movement: ${e}`),(await this.listAnchors(t)).length<10}}export{c as RealityAnchorService};
