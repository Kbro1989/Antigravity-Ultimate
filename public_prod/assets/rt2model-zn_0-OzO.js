import{p as x,x as d}from"./three.module-aN59MUBe.js";import{p as A}from"./enginecache-CxS5uUsY.js";import"./main-Cde5WehW.js";import"../src/services/rsmv/clientscript/index.ts";import"../src/services/rsmv/clientscript/interpreter.ts";function U(z,k){let t=A.classicmodels.read(z,k);const w=4;let y=new Map,h=(e,s)=>{if(e==32767||s<3)return;let n=e&32768?-1:e+1,o=y.get(n);o||(o={tris:0,verts:0},y.set(n,o)),o.verts+=s,o.tris+=s-2};for(let e of t.faces)h(e.color,e.verts.length),h(e.backcolor,e.verts.length);let m=new Map;for(let[e,s]of y.entries())m.set(e,{pos:new x(new Float32Array(s.verts*3),3),normals:new x(new Float32Array(s.verts*3),3),color:new x(new Uint8Array(s.verts*3),3,!0),texuvs:new x(new Float32Array(s.verts*2),2),index:new Uint16Array(s.tris*3),currentface:0,currentindex:0,matid:e});let a=(e,s,n,o)=>{let r=s[n];return e.matid==-1?e.color.setXYZ(e.currentface,(~o>>10&31)/31,(~o>>5&31)/31,(~o>>0&31)/31):e.color.setXYZ(e.currentface,1,1,1),e.pos.setXYZ(e.currentface,t.xpos[r]*w,-t.ypos[r]*w,t.zpos[r]*w),e.normals.setXYZ(e.currentface,f.x,f.y,f.z),e.texuvs.setXY(e.currentface,n==0||n==3?0:1,n==0||n==1?0:1),e.currentface++},f=new d,c=new d,i=new d,v=new d;for(let e of t.faces)if(!(e.verts.length<3)){if(e.color!=32767){let s=e.verts.at(-1),n=e.verts.at(-2),o=e.verts.at(-3);c.set(t.xpos[s],-t.ypos[s],t.zpos[s]),i.set(t.xpos[n],-t.ypos[n],t.zpos[n]),v.set(t.xpos[o],-t.ypos[o],t.zpos[o]),i.sub(c),v.sub(c),f.copy(i).cross(v).normalize();let r=m.get(e.color&32768?-1:e.color+1),b=a(r,e.verts,e.verts.length-1,e.color),u=a(r,e.verts,e.verts.length-2,e.color);for(let l=e.verts.length-3;l>=0;l--){let p=a(r,e.verts,l,e.color);r.index[r.currentindex++]=b,r.index[r.currentindex++]=u,r.index[r.currentindex++]=p,u=p}}if(e.backcolor!=32767){let s=e.verts[0],n=e.verts[1],o=e.verts[2];c.set(t.xpos[s],-t.ypos[s],t.zpos[s]),i.set(t.xpos[n],-t.ypos[n],t.zpos[n]),v.set(t.xpos[o],-t.ypos[o],t.zpos[o]),i.sub(c),v.sub(c),f.copy(i).cross(v).normalize();let r=m.get(e.backcolor&32768?-1:e.backcolor+1),b=a(r,e.verts,0,e.backcolor),u=a(r,e.verts,1,e.backcolor);for(let l=2;l<e.verts.length;l++){let p=a(r,e.verts,l,e.backcolor);r.index[r.currentindex++]=b,r.index[r.currentindex++]=u,r.index[r.currentindex++]=p,u=p}}}return{bonecount:0,miny:0,maxy:0,skincount:0,meshes:[...m.values()].map(e=>{let s=new x(e.index,1);return{indices:s,vertexstart:0,vertexend:e.pos.count,attributes:{pos:e.pos,color:e.color,texuvs:e.texuvs,normals:e.normals},hasVertexAlpha:!1,indexLODs:[s],materialId:e.matid,needsNormalBlending:!0}})}}export{U as parseRT2Model};
