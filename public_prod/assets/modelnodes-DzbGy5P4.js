import{d as c,r as u,e as m}from"./enginecache-CxS5uUsY.js";import"./main-Cde5WehW.js";import{G as g,aG as p,aw as f,h as i}from"./three.module-aN59MUBe.js";import"../src/services/rsmv/clientscript/index.ts";import"../src/services/rsmv/clientscript/interpreter.ts";async function k(...b){return""}class l extends c{chunkdata;loaded=null;cache;rootnode=new g;mixer=new p(this.rootnode);renderscene=null;toggles={};chunkx;chunkz;globalname="";constructor(t,e,s,a,o){super(),this.cache=t,this.chunkx=s,this.chunkz=a,this.chunkdata=(async()=>(this.loaded=await u(t,e,s,a,o),this.rootnode.add(this.loaded.chunkroot),this.onModelLoaded(),this.loaded))()}static defaultopts(t){return{invisibleLayers:!0,collision:!0,map2d:!1,padfloor:!0,skybox:!1,minimap:!1,...t}}static create(t,e,s,a){let o=this.defaultopts(a),n=m(t.engine,e,s,o);return new l(t,n,e,s,o)}async testLocImg(t){if(!this.loaded)throw new Error("not loaded");let e=this.loaded?.locRenders.get(t)??[],s=e.map(r=>r.mesh.cloneSection(r));e.map(r=>r.mesh.setSectionHide(r,!0));let a=new f;a.add(...s.map(r=>r.mesh)),a.traverse(r=>r.layers.set(1)),this.loaded.chunkroot.add(a);let o=this.renderscene.getCurrent2dCamera(),n=await this.renderscene.takeMapPicture(o,256,256,!1,a);return a.removeFromParent(),e.map(r=>r.mesh.setSectionHide(r,!1)),n}cloneLocModel(t){return t.map(e=>e.mesh.cloneSection(e))}replaceLocModel(t,e){let s=this.loaded?.locRenders.get(t)??[];return s.forEach(a=>a.mesh.setSectionHide(a,!0)),e?(this.loaded?.locRenders.set(t,e),e.forEach(a=>a.mesh.setSectionHide(a,!1))):this.loaded?.locRenders.delete(t),s}cleanup(){this.listeners={},this.globalname&&(delete globalThis[this.globalname],this.globalname=""),this.chunkdata.then(t=>t.chunkroot.traverse(e=>{e instanceof i&&e.geometry.dispose()})),this.renderscene?.removeSceneElement(this),this.renderscene=null}async renderSvg(t=0,e=!1,s=1){let{chunk:a,grid:o,chunkSize:n,chunkx:r,chunkz:d}=await this.chunkdata,h={x:r*n,z:d*n,xsize:n,zsize:n};return k(this.cache.engine,o,a?.locs??[],h,t,s,e,!1)}getSceneElements(){return{modelnode:this.rootnode,sky:this.loaded?.sky,options:{hideFloor:!0}}}addToScene(t){if(this.renderscene==null&&globalThis.debugchunks)for(let e=0;e<10;e++){let s=`chunk_${this.chunkx}_${this.chunkz}${e==0?"":`_${e}`}`;if(!globalThis[s]){globalThis[s]=this,this.globalname=s;break}}this.renderscene=t,t.addSceneElement(this)}onModelLoaded(){this.setToggles(this.toggles),this.emit("loaded",this.loaded),this.emit("changed",void 0),this.renderscene?.sceneElementsChanged()}setToggles(t,e=!1){this.toggles=t,this.rootnode.traverse(s=>{if(s.userData.modelgroup){let a=e?!1:t[s.userData.modelgroup]??!0;s.traverse(o=>{o instanceof i&&(o.visible=a)})}})}}export{l as RSMapChunk};
