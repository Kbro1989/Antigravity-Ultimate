POG_LIMB_V6.5
ID:animation
SOURCE_MAP:INTERNAL
---
import { NeuralLimb, LimbConfig } from './NeuralLimb';
import { AgentCapability } from '../AgentConstitution';
import { modelRouter } from '../ModelRouter';
import { BaseIntent } from '../AITypes';

export class AnimationLimb extends NeuralLimb {
    name = 'AnimationLimb';

    constructor(config: LimbConfig) {
        super(config);
    }

    async generate(params: any, intent: BaseIntent & { modelId?: string; provider?: string }) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        const { prompt, options } = params;
        await this.logActivity('generate_motion', 'pending', { prompt });

        const motionResult: any = await modelRouter.route({
            type: 'animation',
            prompt: prompt || 'Generate standard motion',
            options: options,
            modelId: intent.modelId,
            provider: intent.provider
        });

        if (motionResult.clipUrl || motionResult.resultUrl) {
            await this.persistAsset('animation', motionResult.clipUrl || motionResult.resultUrl, { action: 'generate' });
        }

        return {
            status: 'success',
            clipUrl: motionResult.clipUrl || motionResult.resultUrl || 'rsmv://motion:default',
            metadata: motionResult.metadata
        };
    }

    async retarget(params: any, intent: BaseIntent & { modelId?: string; provider?: string }) {
        this.enforceCapability(AgentCapability.AI_INFERENCE);
        const { sourceRig, targetRig, prompt } = params;
        await this.logActivity('retarget_motion', 'pending', { sourceRig, targetRig });

        const motionResult: any = await modelRouter.route({
            type: 'animation',
            prompt: prompt || `Retarget session from ${sourceRig} to ${targetRig}`,
            options: { ...params, action: 'retarget' },
            modelId: intent.modelId,
            provider: intent.provider
        });

        return {
            status: 'success',
            clipUrl: motionResult.clipUrl || motionResult.resultUrl || 'rsmv://motion:retargeted',
            metadata: motionResult.metadata
        };
    }

    async retarget_motion(params: any, intent: BaseIntent) {
        return this.retarget(params, intent as any);
    }
}
