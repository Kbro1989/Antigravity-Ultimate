class o{env;constructor(e){this.env=e}async upsertSnippet(e){if(!this.env.AI||!this.env.VECTOR_INDEX){console.warn("[VectorMemory] AI or Vectorize bindings missing. Skipping upsert.");return}const{data:t}=await this.env.AI.run("@cf/baai/bge-base-en-v1.5",{text:[e.text]}),s=t[0];let r=3;for(;r>0;)try{await this.env.VECTOR_INDEX.upsert([{id:e.id,values:s,metadata:{...e.metadata,text:e.text.substring(0,1e3)}}]),console.log(`[VectorMemory] Upserted snippet: ${e.id}`);break}catch(n){if(r--,r===0)throw n;console.warn(`[VectorMemory] Upsert failed, retrying... (${r} left)`),await new Promise(a=>setTimeout(a,1e3))}}async store(e,t,s){return typeof e=="object"?this.upsertSnippet(e):this.upsertSnippet({id:e,text:t||"",metadata:s||{}})}async queryKnowledge(e,t=3){if(!this.env.AI||!this.env.VECTOR_INDEX)return[];const{data:s}=await this.env.AI.run("@cf/baai/bge-base-en-v1.5",{text:[e]}),r=s[0];return(await this.env.VECTOR_INDEX.query(r,{topK:t,returnMetadata:!0})).matches.map(a=>({id:a.id,score:a.score,text:a.metadata?.text,metadata:a.metadata}))}async search(e,t=3){return this.queryKnowledge(e,t)}}export{o as V};
