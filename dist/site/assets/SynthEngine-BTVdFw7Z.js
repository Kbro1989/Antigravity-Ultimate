class x{audioCtx;isPlaying=!1;timeouts=[];activeNodes=[];constructor(){const t=window.AudioContext||window.webkitAudioContext;this.audioCtx=new t}async play(t){this.stop();let e;if(typeof t=="string")if(t.trim().startsWith("{"))e=JSON.parse(t);else try{const i=await fetch(t);if(!i.ok)throw new Error("Failed to fetch manifest");const a=await i.json();a.manifest?e=a.manifest:e=a}catch(i){console.error("SynthEngine: Could not load manifest from URL",i);return}else e=t;if(!e||!e.tracks){console.error("SynthEngine: Invalid manifest structure",e);return}await this.audioCtx.resume(),this.isPlaying=!0;const s=60/(e.tempo||120),n=this.audioCtx.currentTime+.1;e.tracks.forEach(i=>{this.scheduleTrack(i,n,s)})}stop(){this.isPlaying=!1,this.timeouts.forEach(t=>clearTimeout(t)),this.timeouts=[],this.activeNodes.forEach(t=>{try{t.stop(),t.disconnect()}catch{}}),this.activeNodes=[]}scheduleTrack(t,e,s){let n=e;t.notes.forEach(i=>{const a=i.duration*s;i.note!=="R"&&i.note!=="REST"&&this.playNote(t.type,i.note,n,a,t.volume||.5),n+=a})}playNote(t,e,s,n,i){if(!this.isPlaying)return;const a=this.noteToFreq(e);if(a===0)return;const r=this.audioCtx.createGain();r.connect(this.audioCtx.destination);const h=.02,u=.05,d=Math.max(n,h+u+.01);r.gain.setValueAtTime(0,s),r.gain.linearRampToValueAtTime(i*.5,s+h),r.gain.setValueAtTime(i*.5,s+d-u),r.gain.linearRampToValueAtTime(0,s+d);let o;if(t==="noise"){const c=this.audioCtx.sampleRate*2,f=this.audioCtx.createBuffer(1,c,this.audioCtx.sampleRate),p=f.getChannelData(0);for(let l=0;l<c;l++)p[l]=Math.random()*2-1;o=this.audioCtx.createBufferSource(),o.buffer=f,o.loop=!0}else o=this.audioCtx.createOscillator(),o.type=t,o.frequency.value=a;o.connect(r),o.start(s),o.stop(s+d),this.activeNodes.push(o),o.onended=()=>{r.disconnect();const c=this.activeNodes.indexOf(o);c>-1&&this.activeNodes.splice(c,1)}}noteToFreq(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=t.match(/^([A-G][#b]?)(-?\d+)$/i);if(!s)return 0;let n=s[1].toUpperCase(),i=parseInt(s[2]);if(n.endsWith("B")){const u=n[0],o=(e.indexOf(u)-1+12)%12;n=e[o]}const a=e.indexOf(n);if(a===-1)return 0;const r=(i+1)*12+a;return 440*Math.pow(2,(r-69)/12)}}export{x as SynthEngine};
