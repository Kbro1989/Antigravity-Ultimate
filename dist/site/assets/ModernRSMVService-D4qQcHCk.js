const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/enginecache-DOiY41nD.js","assets/main-Cu5wNbky.js","assets/main-BN3eHhBo.css","assets/three.module-aN59MUBe.js"])))=>i.map(i=>d[i]);
import{l as m,_ as f}from"./main-Cu5wNbky.js";import{C as p,c as o,u as C,i as b,E as g,T as u,p as h,R as y}from"./enginecache-DOiY41nD.js";import{G as k}from"./GLTFLoader-ggi2ZHwC.js";import"./three.module-aN59MUBe.js";import"../src/services/rsmv/clientscript/index.ts";import"../src/services/rsmv/clientscript/interpreter.ts";import"./constants-DucYOER3.js";class j extends p{indices=new Map;dbfiles={};worker;msgidcounter=1;callbacks=new Map;timestamp=new Date;constructor(){super(),this.worker=new Worker(new URL("/assets/sqlitewasmworker-CTKYr96O.js",import.meta.url)),this.worker.onmessage=e=>{let t=this.callbacks.get(e.data.id);if(e.data.error){if(t){let a=e.data.error;t.reqpacket.type=="getfile"?a+=`
 in getfile ${t.reqpacket.major}.${t.reqpacket.minor}`:t.reqpacket.type=="getindex"?a+=`
 in getindex ${t.reqpacket.major}`:a+=`
 in other ${t.reqpacket.type}`,t.reject(new Error(a))}}else t?.resolve(e.data.packet);this.callbacks.delete(e.data.id)}}getCacheMeta(){return{name:"sqlitewasm",descr:"Direclty loads NXT cache files from the disk, in browser compatible environment.",timestamp:this.timestamp}}async generateRootIndex(){console.log("using generated cache index file meta, crc size and version missing");let e=[];for(let t of Object.keys(this.dbfiles)){let a=t.match(/js5-(\d+)\.jcache$/);a&&(e[Number(a[1])]={major:o.index,minor:+a[1],crc:0,size:0,subindexcount:1,subindices:[0],subnames:null,name:null,version:0,uncompressed_crc:0,uncompressed_size:0})}return e}sendWorker(e){let t=this.msgidcounter++;return this.worker.postMessage({id:t,packet:e}),new Promise((a,i)=>this.callbacks.set(t,{resolve:a,reject:i,reqpacket:e}))}giveBlobs(e){Object.assign(this.dbfiles,e),this.sendWorker({type:"blobs",blobs:e})}async giveFsDirectory(e){let t={};if(await e.queryPermission()!="granted")return console.log("tried to open cache without permission"),null;for await(let a of e.values())a.kind=="file"&&(t[a.name]=await a.getFile());this.giveBlobs(t)}async getFile(e,t,a){if(e==o.index)return this.getIndexFile(t);let i=await this.sendWorker({type:"getfile",major:e,minor:t,crc:a});return Buffer.from(i.buffer,i.byteOffset,i.byteLength)}async putFile(e,t,a){await this.sendWorker({type:"putfile",major:e,minor:t,data:a})}async saveCache(e){let t=await this.sendWorker({type:"save",major:e});return Buffer.from(t.buffer,t.byteOffset,t.byteLength)}async getFileArchive(e){let t=await this.getFile(e.major,e.minor,e.crc);return C(t,e.subindices,e.subnames)}async getCacheIndex(e){if(e==o.index)return this.generateRootIndex();let t=this.indices.get(e);return t||(t=this.getIndexFile(e).then(a=>b(e,a,this)),this.indices.set(e,t)),t}async getIndexFile(e){let t=await this.sendWorker({type:"getindex",major:e});return Buffer.from(t.buffer,t.byteOffset,t.byteLength)}close(){this.worker.terminate()}}class ${constructor(e={}){this.config=e}engineCache=null;sceneCache=null;glbLoader=new k;wasmLoader=null;cachePath=null;async ensureInitialized(){this.wasmLoader||(this.wasmLoader=new j,this.wasmLoader.getBuildNr=()=>920)}async linkLocalCache(e="C:\\ProgramData\\Jagex\\RuneScape"){await this.ensureInitialized();const t=await m.listDirectory(e);if(!t?.success||!t.files)return console.error(`RSMV: Failed to read cache at ${e}`),!1;const a={};for(const i of t.files)if(i.name.endsWith(".jcache")){const n=await m.readLocalFile(i.path,!0);if(n.success&&n.content){const c=atob(n.content),r=new Uint8Array(c.length);for(let s=0;s<c.length;s++)r[s]=c.charCodeAt(s);a[i.name]=new Blob([r])}}return Object.keys(a).length===0?(console.warn("RSMV: No .jcache files found in the specified directory"),!1):(this.wasmLoader.giveBlobs(a),this.cachePath=e,this.engineCache=await g.create(this.wasmLoader),this.sceneCache=await u.create(this.engineCache),!0)}async loadModel(e,t){if(this.config.useGlbFirst&&this.config.glbBaseUrl)try{const r=`${this.config.glbBaseUrl}/model_${e}.glb`,s=await this.glbLoader.loadAsync(r);return{id:e,name:`model:${e}`,scene:s.scene,metadata:s.userData}}catch{}if(!this.sceneCache||!this.engineCache)throw new Error("RSMV: Not initialized or cache not linked.");let a=[],i=`model:${e}`,n={id:e};if(t==="npc"||t==="npcs"){const r=await this.engineCache.getFile(o.npcs,e),s=h.npc.read(r,this.engineCache);i=s.name??"Unknown NPC",n={...s,type:"npc"},s.models&&(a=s.models.map(l=>({modelid:l,mods:{}})))}else if(t==="item"||t==="items"){const r=await this.engineCache.getFile(o.items,e),s=h.item.read(r,this.engineCache);i=s.name??"Unknown Item",n={...s,type:"item"};const l=s.model;l&&(a=[{modelid:l,mods:{}}])}else if(t==="object"||t==="objects"){const r=await this.engineCache.getFile(o.objects,e),s=h.object.read(r,this.engineCache);i=s.name??"Unknown Object",n={...s,type:"object"},s.models&&(a=(Array.isArray(s.models)?s.models:[s.models]).map(d=>({modelid:typeof d=="number"?d:d.id,mods:{}})))}else a=[{modelid:e,mods:{}}];a.length===0&&(a=[{modelid:e,mods:{}}]);const c=new y(this.sceneCache,a,i);return{id:e,name:i,scene:c.rootnode,metadata:n}}async loadMap(e){throw new Error("Modern map loading not implemented.")}async loadAudio(e){throw new Error("Modern audio loading not implemented.")}async loadUI(e){throw new Error("Modern UI loading not implemented.")}async getItems(){if(!this.engineCache)return[];const e=[],{iterateConfigFiles:t}=await f(async()=>{const{iterateConfigFiles:a}=await import("./enginecache-DOiY41nD.js").then(i=>i.j);return{iterateConfigFiles:a}},__vite__mapDeps([0,1,2,3]));for await(const{id:a,file:i}of t(this.engineCache,o.items))try{const n=h.item.read(i,this.engineCache);e.push({id:a,name:n.name,description:n.buff_effect||"",metadata:n})}catch{}return e}async getNPCs(){if(!this.engineCache)return[];const e=[],{iterateConfigFiles:t}=await f(async()=>{const{iterateConfigFiles:a}=await import("./enginecache-DOiY41nD.js").then(i=>i.j);return{iterateConfigFiles:a}},__vite__mapDeps([0,1,2,3]));for await(const{id:a,file:i}of t(this.engineCache,o.npcs))try{const n=h.npc.read(i,this.engineCache);e.push({id:a,name:n.name,description:"",metadata:n})}catch{}return e}async getObjects(){if(!this.engineCache)return[];const e=[],{iterateConfigFiles:t}=await f(async()=>{const{iterateConfigFiles:a}=await import("./enginecache-DOiY41nD.js").then(i=>i.j);return{iterateConfigFiles:a}},__vite__mapDeps([0,1,2,3]));for await(const{id:a,file:i}of t(this.engineCache,o.objects))try{const n=h.object.read(i,this.engineCache);e.push({id:a,name:n.name,description:"",metadata:n})}catch{}return e}async loadAvatar(e){throw new Error("Method not implemented.")}dispose(){this.engineCache?.close(),this.sceneCache=null,this.engineCache=null,this.wasmLoader=null}async linkDroppedCache(e){return await this.ensureInitialized(),this.wasmLoader.giveBlobs(e),this.engineCache=await g.create(this.wasmLoader),this.sceneCache=await u.create(this.engineCache),!0}async saveModel(e,t){const a=this.config.stagedPath||this.cachePath;if(!this.engineCache||!this.wasmLoader||!a)return!1;try{const i=h.models.write(t);await this.wasmLoader.putFile(o.models,e,new Uint8Array(i));const n=await this.wasmLoader.saveCache(o.models),c=`js5-${o.models}.jcache`,r=`${a}\\${c}`,s=btoa(String.fromCharCode(...new Uint8Array(n))),l=await m.writeLocalFile(r,s,!0);return console.log(`[RSMV] Model ${e} saved to ${this.config.stagedPath?"STAGING":"CACHE"}: ${r}`),l.success}catch(i){return console.error(`RSMV: Save model ${e} failed:`,i),!1}}getEngineCache(){return this.engineCache}getSceneCache(){return this.sceneCache}}export{$ as ModernRSMVService};
